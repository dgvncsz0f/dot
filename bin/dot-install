#!/bin/sh

def_repo=git://github.com/dgvncsz0f/dot.git

bin_ln=/bin/ln
bin_cat=/bin/cat
bin_cp=/bin/cp
bin_rm=/bin/rm
bin_mv=/bin/mv
bin_mkdir=/bin/mkdir
bin_chmod=/bin/chmod
[ -x "/usr/bin/grep" ] && bin_grep=/usr/bin/grep
[ -x "/bin/grep" ] && bin_grep=/bin/grep
bin_env=/usr/bin/env
bin_find=/usr/bin/find
bin_xmonad=/usr/bin/xmonad
bin_emacs=/usr/bin/emacs
bin_xargs=/usr/bin/xargs
bin_git=/usr/bin/git

envlist="$@"

dot_getenv()
{
  arglist=""
  for env in $envlist
  do
    if echo "$env" | $bin_grep -Eq '^[a-z_]+=[a-zA-Z0-9_/:-]+$'
    then
      eval "$env"
      arglist="$arglist $env"
    fi
  done

  [ -z "$remote" ] && {
    remote=$def_repo
    arglist="$arglist remote=$remote"
  }

  [ -z "$dot_home" ] && {
    dot_home="$HOME/.dot"
    arglist="$arglist dot_home=$HOME/.dot"
  }

  dot_print_info "using:$arglist"
}

dot_print_info()
{
  printf "%s\n" "$1"
}

dot_print_debug()
{
  [ -n "$debug" ] && printf "[debug] %s\n" "$1"
}

dot_print_error()
{
  printf "ERROR - %s\n" "$1"
  exit 1
}

dot_check_binaries()
{
  [ ! -x "$bin_ln" ]  && dot_print_error "$bin_ln not found"
  [ ! -x "$bin_rm" ]  && dot_print_error "$bin_rm not found"
  [ ! -x "$bin_chmod" ] && dot_print_error "$bin_chmod binary not found"
  [ ! -x "$bin_env" ] && dot_print_error "$bin_env binary not found"
  [ ! -x "$bin_find" ] && dot_print_error "$bin_find binary not found"
  [ ! -x "$bin_grep" ] && dot_print_error "$bin_grep binary not found"
  [ ! -x "$bin_xargs" ] && dot_print_error "$bin_xargs binary not found"
  [ ! -x "$bin_cat" ] && dot_print_error "$bin_cat binary not found"
  [ ! -x "$bin_cp" ] && dot_print_error "$bin_cp binary not found"
  [ ! -x "$bin_mv" ] && dot_print_error "$bin_mv binary not found"
  [ ! -x "$bin_git" ] && dot_print_error "$bin_git binary not found"
}

dot_mkdir()
{
  local dir=$1

  [ ! -d "$dir" ] && $bin_mkdir "$dir"
}

dot_symlink()
{
  local src=$1
  local dst=$2

  [ -d "$dst" ] && $bin_rm -r -f "$dst"
  [ -e "$src" ] && $bin_ln -s -f -n "$src" "$dst"
}

dot_download_dot()
{
  dot_print_info "cloning $remote into $dot_home"

  if [ -n "$clean" ]
  then
    dot_print_info "removing $dot_home"
    $bin_rm -r -f "$dot_home"
  fi

  if [ -d "$dot_home" ]
  then
    dot_print_info "trying git pull"
    (cd $dot_home;
      $bin_git ls-files -o -z | $bin_xargs -0 $bin_rm -r -f &&\
      $bin_git reset -q --hard &&\
      $bin_git pull -q origin master) || $bin_rm -r -f "$dot_home"
  fi

  if [ ! -d "$dot_home" ]
  then
    dot_print_info "trying git clone"
    $bin_git clone $remote "$dot_home"
  fi

  (cd $dot_home; $bin_git submodule init; $bin_git submodule update)
}

dot_install()
{
  dot_print_info "installing dot files"

  dot_mkdir   "$HOME/.ssh"
  dot_mkdir   "$HOME/.gnupg"
  if [ -d "$GNUPGHOME" ]
  then
    dot_symlink "$dot_home/dot.gnupg/gpg-agent.conf" "$GNUPGHOME/gpg-agent.conf"
  else
    dot_symlink "$dot_home/dot.gnupg/gpg-agent.conf" "$HOME/.gnupg/gpg-agent.conf"
  fi
  dot_symlink "$dot_home/dot.ssh/config" "$HOME/.ssh/config"
  dot_symlink "$dot_home/dot.emacs" "$HOME/.emacs"
  dot_symlink "$dot_home/dot.libemacs" "$HOME/.libemacs"
  dot_symlink "$dot_home/dot.vim" "$HOME/.vim"
  dot_symlink "$dot_home/dot.vimrc" "$HOME/.vimrc"
  dot_symlink "$dot_home/dot.fonts.conf" "$HOME/.fonts.conf"
  dot_symlink "$dot_home/dot.bash_profile" "$HOME/.bash_profile"
  dot_symlink "$dot_home/dot.bashrc" "$HOME/.bashrc"
  dot_symlink "$dot_home/dot.zshrc" "$HOME/.zshrc"
  dot_symlink "$dot_home/dot.conkerorrc" "$HOME/.conkerorrc"
  dot_symlink "$dot_home/dot.gitconfig" "$HOME/.gitconfig"
  dot_symlink "$dot_home/dot.inputrc" "$HOME/.inputrc"
  dot_symlink "$dot_home/dot.screenrc" "$HOME/.screenrc"
  dot_symlink "$dot_home/dot.tmux.conf" "$HOME/.tmux.conf"
  dot_symlink "$dot_home/dot.xinitrc" "$HOME/.xinitrc"
  dot_symlink "$dot_home/dot.xmobarrc" "$HOME/.xmobarrc"
  dot_symlink "$dot_home/dot.xmodmaprc" "$HOME/.xmodmaprc"
  dot_symlink "$dot_home/dot.xmonad" "$HOME/.xmonad"
  dot_symlink "$dot_home/dot.xresourcesrc" "$HOME/.xresourcesrc"
  dot_symlink "$dot_home/dot.mutt" "$HOME/.mutt"
  dot_symlink "$dot_home/dot.email-signature" "$HOME/.email-signature.txt"
  dot_symlink "$dot_home/dot.octaverc" "$HOME/.octaverc"
  dot_symlink "$dot_home/dot.gtkrc-2.0" "$HOME/.gtkrc-2.0"
  dot_symlink "$dot_home/dot.folders" "$HOME/.folders"
  dot_symlink "$dot_home/bin/run_dzen2" "$dot_home/bin/run_dzen2_bottom"
}

dot_overlay_append()
{
  src=$1
  dst=$2

  if [ -f "$src" ]
  then
    dot_print_info "  append $src into $dst"
    $bin_cat "$src" >>"$dst"
  fi
}

dot_overlay_prpend()
{
  src=$1
  dst=$2

  if [ -f "$src" ]
  then
    dot_print_info "  prpend $src into $dst"
    $bin_cat "$src" "$dst" >"${dst}-overlay-prpend"
    $bin_mv "${dst}-overlay-prpend" "$dst"
  fi
}


dot_overlay_update()
{
  src=$1
  dst=$2

  if [ -f "$src" ]
  then
    dot_print_info "  update $dst with $src"
    $bin_cp "$src" "$dst"
  fi
}

dot_overlay_create()
{
  src=$1
  dst=$2

  if [ ! -f "$dst" ]
  then
    dot_print_info "  create $src to $dst"
    $bin_mkdir -p $(dirname "$dst") 2>/dev/null
    $bin_cp "$src" "$dst"
  fi
}

dot_overlay()
{
  dot_print_info "applying overlay"

  if [ -d "$HOME/dot.overlay/create" ]
  then
    for f in $($bin_find -L $HOME/dot.overlay/create -type f)
    do
      rf=${f##$HOME/dot.overlay/create/}
      dot_overlay_create "$f" "$dot_home/$rf"
    done
  fi
  
  for f in $($bin_find -L "$dot_home" -type f)
  do
    rf=${f##$dot_home/}
    dot_overlay_prpend "$HOME/dot.overlay/prpend/$rf" "$dot_home/$rf"
    dot_overlay_append "$HOME/dot.overlay/append/$rf" "$dot_home/$rf"
    dot_overlay_update "$HOME/dot.overlay/update/$rf" "$dot_home/$rf"
  done
}

dot_fixperms()
{
  $bin_find -L "$dot_home" -type d -exec $bin_chmod 0700 \{\} \;
  $bin_find -L "$dot_home" -type f -exec $bin_chmod 0600 \{\} \;
  $bin_find -L "$dot_home/bin" -type f -exec $bin_chmod 0700 \{\} \;
}

dot_post_xmonad()
{
  dot_print_info "  recompiling xmonad"
  $bin_xmonad --recompile && $bin_xmonad --restart
}

dot_post_emacs()
{
  dot_print_info "  byte-compiling emacs lisp files"
  $bin_rm -f $HOME/.emacs.elc
  $bin_find -L "$dot_home" -name \*.el | $bin_xargs $bin_emacs --user $USER --batch --funcall batch-byte-compile
}

dot_postinst()
{
  dot_fixperms
  [ -x $bin_xmonad ] && dot_post_xmonad
  # [ -x $bin_emacs ]  && dot_post_emacs
  return 0
}

dot_omit_stdout_of()
{
  txt=$1
  cmd=$2
  
  dot_print_info "invoking $txt"
  $cmd 1>/dev/null

  if [ "$?" = "0" ]
  then
    dot_print_info "$txt : ok"
  else
    dot_print_info "$txt : fail"
  fi
}

dot_omit_stderr_of()
{
  txt=$1
  cmd=$2
  
  dot_print_info "invoking $txt"
  if [ -n "$debug" ]
  then
    $cmd
  else
    $cmd 2>/dev/null
  fi

  if [ "$?" = "0" ]
  then
    dot_print_info "$txt : ok"
  else
    dot_print_info "$txt : fail"
  fi
}

dot_check_binaries
dot_getenv
dot_omit_stderr_of "download" dot_download_dot
dot_install
dot_overlay
dot_omit_stderr_of "post install" dot_postinst

