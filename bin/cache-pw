#!/usr/bin/expect -f

set password ""
set passphrase ""
set name "cache-pw"
eval spawn -noecho [lrange $argv 0 [llength $argv]]

proc read_passwd {} {
    global password
    global name
    if { $password == "" } {
        send_user "($name) password: "
        expect_user -re "(.*)\r"
        set password $expect_out(1,string)
    } else {
        send_user "($name) using cache"
        sleep 1
    }
}

proc read_passphrase {} {
    global passphrase
    global name
    if { $passphrase == "" } {
        send_user "($name) passphrase: "
        expect_user -re "(.*)\r"
        set passphrase $expect_out(1,string)
    } else {
        send_user "($name) using cache"
        sleep 1
    }
}

proc purge_cache {} {
    global passphrase
    global password
    global name
    send_user "($name) purging cache\n"
    set passphrase ""
    set password ""
}

interact \
    ~. {
        purge_cache
    } -o \
    -nobuffer -re "\[pP\]assword.*: $" {
        read_passwd
        send "$password\n"
    } -nobuffer -re "passphrase.*: $" {
        read_passphrase
        send "$passphrase\n"
    }

