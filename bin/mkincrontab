#!/bin/sh

bin_incrontab=${bin_incrontab:-/usr/bin/incrontab}
bin_find=${bin_find:-/usr/bin/find}
bin_uniq=${bin_uniq:-/usr/bin/uniq}
bin_sort=${bin_sort:-/usr/bin/sort}

srcroot=$(pwd)
basedir=$1

mkincrontab_abspath()
{
  local file_or_dir=$1

  if [ -f "$file_or_dir" ]
  then
    cd $(dirname "$file_or_dir") 2>/dev/null
  else
    cd "$file_or_dir" 2>/dev/null
  fi && pwd
}

mkincrontab_current()
{
  $bin_incrontab -l
}

mkincrontab_gather()
{
  local mydir=$(mkincrontab_abspath "$basedir")
  for dir in $($bin_find "$mydir" -type d ! -wholename "$mydir/.git*" -a ! -wholename "$mydir/.hg*")
  do
    echo "$dir" IN_CLOSE_WRITE,IN_NO_LOOP /home/dsouza/.dot/bin/mktags "$srcroot" '$@/$#'
  done
}

mkincrontab_dump()
{
  { mkincrontab_gather; mkincrontab_current; } | $bin_sort | $bin_uniq
}

mkincrontab_install()
{
  mkincrontab_dump | $bin_incrontab -
}

mkincrontab_dump
read -p "install new incrontab? [N|y] " -r accept
[ "$accept" = "y" ] && mkincrontab_install
