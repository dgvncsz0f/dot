#!/bin/bash
# -*- mode: Shell-script; sh-basic-offset: 2; -*-

. $HOME/.bash.d/init

export GNUPGHOME="$HOME/enc/gnupg"
export GPG_TTY=$(/usr/bin/tty)

dx15_gnupg_envfile=$HOME/.gpg-agent.env

dx15_gnupg_export ()
{
  if [ -f $dx15_gnupg_envfile ]
  then
    eval $(cat $dx15_gnupg_envfile)
  fi
}

dx15_gnupg_running ()
{
  dx15_gnupg_export
  if /usr/bin/gpg-connect-agent --agent-program /bin/false /bye 2>/dev/null
  then
    return 0
  else
    rm -f $dx15_gnupg_envfile
    return 1
  fi
}

dx15_gnupg_init ()
{
  if ! dx15_gnupg_running
  then
    if [ -d $HOME/enc/gnupg ]
    then
      /usr/bin/gpg-agent              \
        --sh                          \
        --daemon                      \
        --homedir $HOME/enc/gnupg     \
        --max-cache-ttl 28800         \
        --default-cache-ttl 28800     \
        --max-cache-ttl-ssh 28800     \
        --enable-ssh-support          \
        --default-cache-ttl-ssh 28800 >$dx15_gnupg_envfile
    fi
  fi
}

! dx15_is_remote && {
  dx15_gnupg_init
  dx15_gnupg_export
}
